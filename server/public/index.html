<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Skybox — Load History</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:          #0d0f1a;
      --surface:     #13162100;
      --card:        #181b2a;
      --card-hover:  #1e2236;
      --border:      #272b3f;
      --accent:      #5b8def;
      --accent-dim:  #2e4a80;
      --text:        #d8dff0;
      --muted:       #64697e;
      --radius:      10px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
    }

    /* ── header ── */
    header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 28px;
      background: #10121e;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logo {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-right label {
      font-size: 0.82rem;
      color: var(--muted);
    }

    #date-select {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.88rem;
      cursor: pointer;
      outline: none;
      min-width: 180px;
    }

    #date-select:focus { border-color: var(--accent); }

    /* ── main ── */
    main {
      max-width: 860px;
      margin: 0 auto;
      padding: 28px 20px;
    }

    .day-summary {
      font-size: 0.82rem;
      color: var(--muted);
      margin-bottom: 18px;
    }

    .load-list { display: flex; flex-direction: column; gap: 10px; }

    /* ── load card ── */
    .load-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: border-color 0.15s;
    }

    .load-card.open { border-color: var(--accent-dim); }

    .load-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 18px;
      cursor: pointer;
      user-select: none;
    }

    .load-header:hover { background: var(--card-hover); }

    .load-num {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      min-width: 44px;
      text-align: center;
      line-height: 1;
    }

    .load-body { flex: 1; min-width: 0; }

    .load-aircraft {
      font-size: 0.97rem;
      font-weight: 600;
    }

    .load-meta {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .load-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .pill {
      background: var(--accent-dim);
      color: #a8c4f8;
      padding: 3px 11px;
      border-radius: 20px;
      font-size: 0.78rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .chevron {
      color: var(--muted);
      font-size: 0.75rem;
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    .load-card.open .chevron { transform: rotate(180deg); }

    /* ── jumpers panel ── */
    .jumpers-wrap {
      display: none;
      border-top: 1px solid var(--border);
      padding: 14px 18px 16px;
    }

    .load-card.open .jumpers-wrap { display: block; }

    table.jt {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.83rem;
    }

    table.jt th {
      text-align: left;
      padding: 6px 10px;
      color: var(--muted);
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border-bottom: 1px solid var(--border);
    }

    table.jt td {
      padding: 8px 10px;
      border-bottom: 1px solid #1e2133;
      vertical-align: middle;
    }

    table.jt tr:last-child td { border-bottom: none; }
    table.jt tr:hover td { background: rgba(255,255,255,0.02); }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.72rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .b-sport    { background: #1e3060; color: #7aabf8; }
    .b-tandem   { background: #301a5a; color: #c49af8; }
    .b-student  { background: #1a3525; color: #7ae8a0; }
    .b-inst     { background: #2a2a10; color: #e8d870; }
    .b-other    { background: #282830; color: #a0a8c8; }

    .empty {
      text-align: center;
      color: var(--muted);
      padding: 60px 0;
      font-size: 0.92rem;
    }
  </style>
</head>
<body>

<header>
  <span class="logo">Skybox</span>
  <div class="header-right">
    <label for="date-select">Date</label>
    <select id="date-select"><option>Loading…</option></select>
  </div>
</header>

<main id="main">
  <p class="empty">Loading…</p>
</main>

<script>
"use strict";

// ── helpers ──────────────────────────────────────────────────────────────────

function esc(s) {
  return String(s ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function fmtDate(iso) {
  const [y, m, d] = iso.split("-").map(Number);
  return new Date(y, m - 1, d).toLocaleDateString("en-GB", {
    weekday: "long", day: "numeric", month: "long", year: "numeric",
  });
}

function fmtTime(iso) {
  return new Date(iso).toLocaleTimeString("en-GB", {
    hour: "2-digit", minute: "2-digit",
  });
}

function typeBadge(type) {
  if (!type) return "";
  const t = type.toLowerCase();
  const cls = t.includes("tandem instructor") || t.includes("ti") ? "b-inst"
            : t.includes("tandem")   ? "b-tandem"
            : t.includes("student")  ? "b-student"
            : t.includes("sport")    ? "b-sport"
            : t.includes("aff")      ? "b-student"
            : t.includes("instructor") ? "b-inst"
            : "b-other";
  return `<span class="badge ${cls}">${esc(type)}</span>`;
}

// ── rendering ────────────────────────────────────────────────────────────────

function renderLoads(loads) {
  const main = document.getElementById("main");

  if (!loads.length) {
    main.innerHTML = '<p class="empty">No departed loads on this date.</p>';
    return;
  }

  const total = loads.reduce((n, l) => {
    const jj = Array.isArray(l.jumpers) ? l.jumpers.filter(j => j.name) : [];
    return n + jj.length;
  }, 0);

  let html = `<p class="day-summary">${loads.length} load${loads.length !== 1 ? "s" : ""} &nbsp;·&nbsp; ${total} jumpers</p>`;
  html += '<div class="load-list">';

  for (const load of loads) {
    const jumpers = Array.isArray(load.jumpers) ? load.jumpers.filter(j => j.name) : [];

    const rows = jumpers.map(j => `
      <tr>
        <td>${esc(j.name)}</td>
        <td>${typeBadge(j.type)}</td>
        <td>${esc(j.formation)}</td>
        <td>${esc(j.group_name)}</td>
        <td>${esc(j.rig)}</td>
      </tr>`).join("");

    const jumperTable = jumpers.length
      ? `<table class="jt">
           <thead><tr>
             <th>Name</th><th>Type</th><th>Jump</th><th>Group</th><th>Rig</th>
           </tr></thead>
           <tbody>${rows}</tbody>
         </table>`
      : `<p style="font-size:.83rem;color:var(--muted)">No jumper data recorded.</p>`;

    const lm = load.load_master ? `LM: ${esc(load.load_master)} &nbsp;&middot;&nbsp; ` : "";

    html += `
      <div class="load-card" id="lc-${load.id}">
        <div class="load-header" onclick="toggle(${load.id})">
          <div class="load-num">#${load.load_number}</div>
          <div class="load-body">
            <div class="load-aircraft">${esc(load.aircraft)}</div>
            <div class="load-meta">${lm}Departed ${fmtTime(load.departed_at)}</div>
          </div>
          <div class="load-right">
            <span class="pill">${jumpers.length} jumper${jumpers.length !== 1 ? "s" : ""}</span>
          </div>
          <span class="chevron">&#9660;</span>
        </div>
        <div class="jumpers-wrap">${jumperTable}</div>
      </div>`;
  }

  html += "</div>";
  main.innerHTML = html;
}

function toggle(id) {
  document.getElementById(`lc-${id}`).classList.toggle("open");
}

// ── data fetching ─────────────────────────────────────────────────────────────

async function loadLoads(date) {
  document.getElementById("main").innerHTML = '<p class="empty">Loading…</p>';
  const res  = await fetch(`/api/loads?date=${date}`);
  const data = await res.json();
  renderLoads(data);
}

async function init() {
  const res   = await fetch("/api/dates");
  const dates = await res.json();
  const sel   = document.getElementById("date-select");

  if (!dates.length) {
    sel.innerHTML = "<option>No data yet</option>";
    document.getElementById("main").innerHTML =
      '<p class="empty">No loads recorded yet — waiting for the first departure.</p>';
    return;
  }

  sel.innerHTML = dates
    .map(d => `<option value="${d}">${fmtDate(d)}</option>`)
    .join("");

  const today = new Date().toISOString().slice(0, 10);
  sel.value = dates.includes(today) ? today : dates[0];

  sel.addEventListener("change", e => loadLoads(e.target.value));
  loadLoads(sel.value);
}

init();
</script>
</body>
</html>
